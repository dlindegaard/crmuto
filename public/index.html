<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>crmuto</title>
    <!-- Link to stylesheet style.css -->
    <link rel="stylesheet" href="style.css">
    <script type="module">
        import { app } from './js/app.js';
        window.app = app;
    </script>
    <script src="external/alpine.js" defer></script>
</head>

<!-- Application is using Alpine.js -->

<body>
    <div x-data="app" x-init="init()">
        <ul>
            <li><a href="#" @click.prevent="setActiveView('api-key-view')">Set API key</a></li>
            <li><a href="#" @click.prevent="setActiveView('contacts-view')">Contacts</a></li>
            <li><a href="#" @click.prevent="setActiveView('lists-view')">Lists</a></li>
        </ul>
        <div x-show="activeView==='api-key-view'">
            <label>
                API Key:
                <input type="text" x-model="apiKey" />
            </label>
            <button @click="setApiKey()">Set API Key</button>
            <button @click="unsetApiKey()">Remove API Key</button>
        </div>
        <div x-show="activeView==='contacts-view'">
            <h1>Contacts</h1>
            <div x-show="contactsViewState=='normal'">
                <button class="mt-3" @click="initContactsFiltering">Filter contacts</button>
            </div>
            <div x-show="contactsViewState=='filtering'">
                <button class="mt-3" @click="cancelContactsFiltering">Cancel filtering</button>
                <div class="mt-3">
                    <label for="filterSelect">Add List:</label>
                    <select id="filterSelect" x-model="selectedFilter">
                        <option value="" disabled selected>Select a list</option>
                        <template x-for="list in lists" :key="list.id">
                            <option x-text="list.name" :value="list.id"></option>
                        </template>
                    </select>
                    <button @click="addFilter()">Add list to filter</button>
                </div>
                <div class="mt-3" x-show="editFilters.length>0">
                    <h3 class="mb-2">Lists in filter:</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>List</th>
                                <th>Condition</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(filter, index) in editFilters" :key="index">
                                <tr>
                                    <td x-text="filter.name"></td>
                                    <td>
                                        <select x-model="filter.type" @change="filterChangeTracker++">
                                            <option value="in">Contacts in list</option>
                                            <option value="notIn">Contact is NOT in list</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button @click="removeFilter(index)">Remove</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <label>
                        <span x-show="changesToFilters" class="highlight">Changes have been made to the filter, do you want to apply them?</span>
                        <button class="mt-3" @click="applyFilters()">Apply filter(s)</button>
                    </label>
                </div>
                <h4 class="mt-3" x-show="editFilters.length==0">No active filters</h4>
            </div>
            <p class="mt-3">Total number of contacts: <span x-text="contacts.length"></span></p>
            <table class="mt-3">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="contact in contacts">
                        <tr>
                            <td x-text="contact.email"></td>
                            <td x-text="contact.firstName"></td>
                            <td x-text="contact.lastName"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <button class="mt-3" @click="prevUsers()" :disabled="currentPage === 0">Previous</button>
            <button @click="nextUsers()" :disabled="currentPage >= totalPages - 1">Next</button>
            <p class="mt-3">Page: <span x-text="currentPage + 1"></span> / <span x-text="totalPages"></span></p>
        </div>
        <div x-show="activeView==='lists-view'">
            <h1>Lists</h1>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Unique Subscribers</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="list in lists" :key="list.id">
                        <tr>
                            <td x-text="list.name"></td>
                            <td x-text="list.meta.uniqueSubscribers"></td>
                            <td>
                                <button @click="createDealsForList(list.id)">Create Deals for all contacts</button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        <div x-show="isLoading" class="loading-overlay">
            <div class="spinner"></div>
        </div>
    </div>
</body>

</html>